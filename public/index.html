<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>dVPN Node</title>
    <script type="text/javascript" src="https://unpkg.com/ansi2html-extended@0.0.4/lib/ansi2html.js"></script>
</head>

<style>
    #console {
        position: absolute;
        bottom: 0;
        display: block;
        height: 30%;
        overflow: auto;
        width: 100%;
        background-color: black;
        color: greenyellow;
    }
</style>

<body>
    <script type="text/javascript">
        var sock = null;
        var wsuri = "ws://localhost:9000/api/socket";

        window.onload = function() {

            console.log("onload");

            sock = new WebSocket(wsuri);

            sock.onopen = function() {
                console.log("connected to " + wsuri);
            }

            sock.onclose = function(e) {
                console.log("connection closed (" + e.code + ")");
                console.log(e.data);
            }

            sock.onmessage = function(e) {
                //console.log("message received: " + e.data);
                var stdOut = document.getElementById('console');
                stdOut.innerHTML += "<br/>" + e.data
                stdOut.scrollTop = stdOut.scrollHeight;
            }

            sock.onerror = function(e) {
                console.log(e);
            }
        };

        function send() {
            // var msg = document.getElementById('message').value;
            // sock.send(msg);

            const Http = new XMLHttpRequest();

            Http.onreadystatechange = function() {
                getNode();
            }

            const url='http://localhost:9000/api/node/start/stream';
            Http.open("GET", url);
            Http.send();
        };

        function getNode() {
            const Http = new XMLHttpRequest();

            Http.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var resp = JSON.parse((this.responseText))
                    console.log(resp)
                    if (resp.Online == true) {
                        document.getElementById("node-status").innerHTML = "Running";
                        document.getElementById("process-id").innerHTML = resp.Pid;
                        document.getElementById("node-status").style.color = "darkgreen"
                    } else {
                        document.getElementById("node-status").innerHTML = "Stopped";
                        document.getElementById("process-id").innerHTML = "Unavailable";
                        document.getElementById("node-status").style.color = "red"
                    }
                }
            };

            const url='http://localhost:9000/api/node';
            Http.open("GET", url);
            Http.send();
        }

        function kill() {
            const Http = new XMLHttpRequest();
            const url='http://localhost:9000/api/node/kill';
            Http.open("POST", url);
            Http.send();
        }

        getNode();
    </script>
    <h1>dVPN</h1>
    <div id="node-control">
        <div>Process Status: <div id="node-status" style="display:inline-block;">...</div></div>
        <div>ProcessID: <div id="process-id" style="display:inline-block;">...</div></div>
        <br/>
        <button onclick="send();">Start Node</button>
        <button style="display:none;" onclick="kill();">Kill Node</button>
    </div>
    <div id="config-control">

    </div>
    <div id="console" style="position:absolute; bottom:0;">
    </div>
</body>
</html>